{% extends 'base.html' %} {% block title %}Contr√¥le vocal{% endblock %} {% block
content %}
<h1>Contr√¥le vocal de la porte</h1>
<div class="card">
  <button id="start-btn">üé§ Parler</button>
  <div id="result"></div>
</div>
{% endblock %} {% block scripts %}
<script>
  const startBtn = document.getElementById("start-btn");
  const resultDiv = document.getElementById("result");

  // V√©rifier la compatibilit√© du navigateur
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Votre navigateur ne supporte pas la reconnaissance vocale.");
  } else {
    const recognition = new SpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    startBtn.addEventListener("click", () => {
      recognition.start();
      resultDiv.textContent = "üéôÔ∏è J'√©coute...";
    });

    recognition.addEventListener("result", (event) => {
      const transcript = event.results[0][0].transcript;
      resultDiv.textContent = `Vous avez dit: "${transcript}"`;

      fetch("{% url 'send_command' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ phrase: transcript.toLowerCase() }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.status === "ok") {
            resultDiv.textContent = `‚úÖ Action envoy√©e : ${data.action}`;
          } else {
            resultDiv.textContent = `‚ùå ${data.message}`;
          }
        })
        .catch((err) => {
          console.error(err);
          resultDiv.textContent = "‚ö†Ô∏è Erreur de communication avec le serveur.";
        });
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
