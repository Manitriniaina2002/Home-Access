{% extends 'base.html' %} 
{% block title %}Tableau de bord{% endblock %} 
{% block extra_css %}
<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
  }

  /* Card appearance and spacing */
  .dashboard-card {
    border-radius: var(--radius-xl);
    transition: transform var(--transition-fast),
      box-shadow var(--transition-fast);
    background: white;
    border: 1px solid var(--neutral-100);
    padding: var(--space-6);
  }

  .dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  /* Card header layout */
  .card-header {
    display: flex;
    gap: var(--space-4);
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .card-icon {
    font-size: var(--text-2xl);
    padding: var(--space-2);
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
  }

  .card-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
    margin: 0;
  }

  .card-subtitle {
    color: var(--neutral-500);
    font-size: var(--text-sm);
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--neutral-100);
  }

  .stat-item:last-child {
    border-bottom: none;
  }

  .stat-label {
    color: var(--neutral-500);
    font-size: var(--text-sm);
  }

  .stat-value {
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
  }

  .quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    margin-top: var(--space-6);
  }

  .action-btn {
    padding: var(--space-3);
    background: var(--neutral-50);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-md);
    cursor: pointer;
    text-align: center;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--neutral-600);
    transition: all var(--transition-fast);
  }

  .action-btn:hover {
    background: var(--neutral-100);
    border-color: var(--primary-500);
    color: var(--primary-600);
  }

  .welcome-section {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: var(--radius-2xl);
    padding: var(--space-8) var(--space-6);
    margin-bottom: var(--space-8);
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .welcome-section::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      rgba(255, 255, 255, 0.05) 10px,
      rgba(255, 255, 255, 0.05) 20px
    );
    animation: slide 20s linear infinite;
  }

  @keyframes slide {
    0% {
      transform: translate(-50%, -50%);
    }
    100% {
      transform: translate(-40%, -40%);
    }
  }

  .welcome-content {
    position: relative;
    z-index: 1;
  }

  .welcome-title {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-2);
  }

  .welcome-subtitle {
    font-size: var(--text-lg);
    opacity: 0.9;
    margin-bottom: var(--space-6);
  }

  .system-time {
    font-size: var(--text-sm);
    opacity: 0.8;
  }

  .device-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--space-4);
  }

  .device-item {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--neutral-50);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .device-item:hover {
    background: var(--neutral-100);
    border-color: var(--primary-500);
  }

  .device-icon {
    font-size: var(--text-xl);
    width: 40px;
    text-align: center;
  }

  .device-name {
    font-weight: var(--font-medium);
    color: var(--neutral-700);
    margin-bottom: var(--space-1);
  }

  .device-status {
    font-size: var(--text-xs);
    color: var(--neutral-500);
  }

  @media (max-width: 768px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .quick-actions {
      grid-template-columns: 1fr;
    }

    .welcome-section {
      padding: var(--space-6) var(--space-4);
    }

    .welcome-title {
      font-size: var(--text-2xl);
    }
  }

  /* MQTT log table improvements */
  #mqtt-log-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
  }

  #mqtt-log-table thead th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    color: var(--neutral-700);
    border-bottom: 1px solid var(--neutral-100);
    background: transparent;
  }

  #mqtt-log-table tbody td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--neutral-100);
    vertical-align: top;
  }

  #mqtt-log-table tbody tr:hover {
    background: rgba(14, 165, 233, 0.04);
  }

  .mqtt-payload {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",
      "Courier New", monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 36ch;
    display: inline-block;
    vertical-align: middle;
  }

  /* Make quick actions stack on narrow screens */
  @media (max-width: 480px) {
    .quick-actions {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="welcome-section">
  <div class="welcome-content">
    <h1 class="welcome-title">Bienvenue, {{ user.username }} !</h1>
    <p class="welcome-subtitle">Vue d'ensemble de votre espace</p>
    <div class="system-time" id="current-time" aria-live="polite"></div>
  </div>
</div>

<div class="dashboard-grid">
  <div
    class="dashboard-card"
    role="region"
    aria-labelledby="system-status-title"
  >
    <div class="card-header">
      <div class="card-icon" aria-hidden="true">‚ö°</div>
      <div>
        <h2 class="card-title" id="system-status-title">√âtat du Syst√®me</h2>
        <p class="card-subtitle">Statut des services</p>
      </div>
    </div>

    <div class="stat-item">
      <span class="stat-label">Services</span>
      <span class="status-badge status-online" aria-label="Services en ligne"
        >En ligne</span
      >
    </div>
    <div class="stat-item">
      <span class="stat-label">Connectivit√©</span>
      <span
        class="status-badge status-online"
        id="mqtt-status"
        aria-label="Connectivit√© active"
        >Active</span
      >
    </div>
    <div class="stat-item">
      <span class="stat-label">Base de donn√©es</span>
      <span
        class="status-badge status-online"
        aria-label="Base de donn√©es op√©rationnelle"
        >Op√©rationnelle</span
      >
    </div>
    <div class="stat-item">
      <span class="stat-label">Reconnaissance vocale</span>
      <span
        class="status-badge"
        id="speech-status"
        aria-label="Reconnaissance vocale disponible"
        >Disponible</span
      >
    </div>
  </div>

  <div
    class="dashboard-card"
    role="region"
    aria-labelledby="voice-commands-title"
  >
    <div class="card-header">
      <div class="card-icon" aria-hidden="true">üé§</div>
      <div>
        <h2 class="card-title" id="voice-commands-title">Commandes Vocales</h2>
        <p class="card-subtitle">Statistiques d'utilisation</p>
      </div>
    </div>

    <div class="stat-item">
      <span class="stat-label">Commandes aujourd'hui</span>
      <span class="stat-value" id="commands-today">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Taux de r√©ussite</span>
      <span class="stat-value">95%</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Derni√®re commande</span>
      <span class="stat-value" id="last-command">Aucune</span>
    </div>

    <div class="quick-actions">
      <a href="{% url 'voice' %}" class="action-btn"> üéôÔ∏è Contr√¥le vocal </a>
      <button
        class="action-btn"
        onclick="testVoiceRecognition()"
        aria-label="Tester le microphone"
      >
        üîß Tester micro
      </button>
    </div>
  </div>

  <div
    class="dashboard-card"
    role="region"
    aria-labelledby="connected-devices-title"
  >
    <div class="card-header">
      <div class="card-icon" aria-hidden="true">üè†</div>
      <div>
        <h2 class="card-title" id="connected-devices-title">
          Appareils Connect√©s
        </h2>
        <p class="card-subtitle">Dispositifs MQTT</p>
      </div>
    </div>

    <div class="device-grid">
      <div class="device-item">
        <div class="device-icon" aria-hidden="true">üö™</div>
        <div class="device-details">
          <div class="device-name">Porte d'entr√©e</div>
          <div class="device-status">home_acces/door</div>
        </div>
      </div>

      <div class="device-item">
        <div class="device-icon" aria-hidden="true">üí°</div>
        <div class="device-details">
          <div class="device-name">√âclairage</div>
          <div class="device-status">home_acces/lights</div>
        </div>
      </div>

      <div class="device-item">
        <div class="device-icon" aria-hidden="true">üîí</div>
        <div class="device-details">
          <div class="device-name">S√©curit√©</div>
          <div class="device-status">home_acces/security</div>
        </div>
      </div>
    </div>

    <div class="quick-actions">
      <button
        class="action-btn"
        onclick="refreshDevices()"
        aria-label="Actualiser les appareils"
      >
        üîÑ Actualiser
      </button>
      <button
        class="action-btn"
        onclick="scrollToMqttLog()"
        aria-label="Voir les logs MQTT"
      >
        üìú Logs MQTT
      </button>
    </div>
  </div>

  <div
    class="dashboard-card"
    id="mqtt-log-section"
    role="region"
    aria-labelledby="mqtt-log-title"
  >
    <div class="card-header">
      <div class="card-icon" aria-hidden="true">üìú</div>
      <div>
        <h2 class="card-title" id="mqtt-log-title">Logs MQTT (porte)</h2>
        <p class="card-subtitle">Derniers √©v√©nements re√ßus</p>
      </div>
    </div>
    <div style="overflow-x: auto">
      <table
        class="min-w-full text-sm"
        id="mqtt-log-table"
        aria-describedby="mqtt-log-title"
      >
        <thead>
          <tr>
            <th scope="col" class="px-2 py-1">Horodatage</th>
            <th scope="col" class="px-2 py-1">Statut</th>
            <th scope="col" class="px-2 py-1">Payload</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="3" style="text-align: center">Chargement...</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="quick-actions">
      <button
        class="action-btn"
        onclick="refreshMqttLog()"
        aria-label="Rafra√Æchir les logs MQTT"
      >
        üîÑ Rafra√Æchir
      </button>
    </div>
  </div>

  <div
    class="dashboard-card"
    role="region"
    aria-labelledby="recent-activity-title"
  >
    <div class="card-header">
      <div class="card-icon" aria-hidden="true">üìã</div>
      <div>
        <h2 class="card-title" id="recent-activity-title">Activit√© R√©cente</h2>
        <p class="card-subtitle">Derni√®res actions</p>
      </div>
    </div>

    <div id="recent-activity">
      <div class="stat-item">
        <span class="stat-label">Syst√®me d√©marr√©</span>
        <span class="stat-value" id="startup-time"></span>
      </div>
    </div>

    <div class="quick-actions">
      <button
        class="action-btn"
        onclick="clearActivityLog()"
        aria-label="Vider les logs d'activit√©"
      >
        üóëÔ∏è Vider logs
      </button>
      <button
        class="action-btn"
        onclick="exportLogs()"
        aria-label="Exporter les logs"
      >
        üì§ Exporter
      </button>
    </div>
  </div>
</div>

{% if user.is_staff %}
<div class="card" role="region" aria-labelledby="admin-actions-title">
  <h2
    id="admin-actions-title"
    class="text-lg font-semibold mb-4 text-neutral-900"
  >
    ‚öôÔ∏è Administration
  </h2>
  <div class="quick-actions" style="grid-template-columns: repeat(3, 1fr)">
    <a href="/admin/" class="action-btn" target="_blank"> üîß Django Admin </a>
    <button
      class="action-btn"
      onclick="manageVoiceCommands()"
      aria-label="G√©rer les commandes vocales"
    >
      üé§ G√©rer commandes
    </button>
    <button
      class="action-btn"
      onclick="viewSystemLogs()"
      aria-label="Voir les logs syst√®me"
    >
      üìä Logs syst√®me
    </button>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  let activityCount = 0;
  let lastEventTimestamps = [];
  let ws;

  function scrollToMqttLog() {
    const section = document.getElementById("mqtt-log-section");
    if (section) section.scrollIntoView({ behavior: "smooth" });
  }

  function renderMqttLog(events, highlightNew = true) {
    const tbody = document.querySelector("#mqtt-log-table tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!events.length) {
      tbody.innerHTML =
        '<tr><td colspan="3" style="text-align:center;">Aucun √©v√©nement</td></tr>';
      lastEventTimestamps = [];
      return;
    }
    const newTimestamps = events.map((e) => e.timestamp);
    for (const e of events) {
      const row = document.createElement("tr");
      const isNew =
        highlightNew &&
        lastEventTimestamps.length &&
        !lastEventTimestamps.includes(e.timestamp);
      const timestamp = String(e.timestamp)
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      const status = String(e.status)
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      const payload = String(e.payload || "")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      row.innerHTML = `<td class="px-2 py-1">${timestamp}</td><td class="px-2 py-1">${status}</td><td class="px-2 py-1"><span class="mqtt-payload">${payload}</span></td>`;
      if (isNew) row.style.background = "#d1fae5";
      tbody.appendChild(row);
    }
    lastEventTimestamps = newTimestamps;
  }

  function connectMqttLogWebSocket() {
    let protocol = window.location.protocol === "https:" ? "wss" : "ws";
    let wsUrl = `${protocol}://${window.location.host}/ws/door_events/`;
    ws = new WebSocket(wsUrl);
    ws.onopen = () => {
      showToast("Connexion WebSocket MQTT √©tablie", "success");
    };
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.events) {
          if (data.events.length === 1 && lastEventTimestamps.length) {
            const current = Array.from(
              document.querySelectorAll("#mqtt-log-table tbody tr")
            ).map((tr) => ({
              timestamp: tr.children[0].textContent,
              status: tr.children[1].textContent,
              payload: tr.children[2].textContent,
            }));
            renderMqttLog([data.events[0], ...current].slice(0, 20));
          } else {
            renderMqttLog(data.events);
          }
        }
      } catch (e) {
        console.error("WebSocket message error:", e);
      }
    };
    ws.onclose = () => {
      showToast("WebSocket MQTT d√©connect√©, reconnexion dans 3s", "warning");
      setTimeout(connectMqttLogWebSocket, 3000);
    };
  }

  function refreshMqttLog() {
    showToast("Logs MQTT en temps r√©el", "info");
  }

  function updateTime() {
    const now = new Date();
    document.getElementById(
      "current-time"
    ).textContent = `Derni√®re mise √† jour: ${now.toLocaleString("fr-FR")}`;
  }

  function checkSpeechRecognition() {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const statusElement = document.getElementById("speech-status");

    if (SpeechRecognition) {
      statusElement.textContent = "Disponible";
      statusElement.className = "status-badge status-online";
    } else {
      statusElement.textContent = "Non support√©";
      statusElement.className = "status-badge status-offline";
    }
  }

  function testVoiceRecognition() {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      showToast("Reconnaissance vocale non support√©e", "error");
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    showToast("Test du microphone... Dites quelque chose !", "info");

    recognition.start();

    recognition.addEventListener("result", (event) => {
      const transcript = event.results[0][0].transcript
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      showToast(`Microphone OK ! Vous avez dit: "${transcript}"`, "success");
      addActivityLog(`Test microphone: "${transcript}"`);
    });

    recognition.addEventListener("error", () => {
      showToast("Erreur microphone ou autorisation refus√©e", "error");
    });
  }

  function addActivityLog(message) {
    const activityDiv = document.getElementById("recent-activity");
    const newActivity = document.createElement("div");
    newActivity.className = "stat-item";
    newActivity.innerHTML = `
      <span class="stat-label">${message
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")}</span>
      <span class="stat-value">${new Date().toLocaleTimeString("fr-FR")}</span>
    `;

    if (activityDiv.children.length > 1) {
      activityDiv.insertBefore(newActivity, activityDiv.children[1]);
    } else {
      activityDiv.appendChild(newActivity);
    }

    while (activityDiv.children.length > 6) {
      activityDiv.removeChild(activityDiv.lastChild);
    }

    activityCount++;
    document.getElementById("commands-today").textContent = activityCount;
    document.getElementById("last-command").textContent = message
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function refreshDevices() {
    showToast("Actualisation des appareils...", "info");
    fetch("/api/devices/", {
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        const deviceGrid = document.querySelector(".device-grid");
        deviceGrid.innerHTML = data.devices
          .map(
            (device) => `
          <div class="device-item">
            <div class="device-icon" aria-hidden="true">${device.icon.replace(
              /</g,
              "&lt;"
            )}</div>
            <div class="device-details">
              <div class="device-name">${device.name.replace(
                /</g,
                "&lt;"
              )}</div>
              <div class="device-status">${device.status.replace(
                /</g,
                "&lt;"
              )}</div>
            </div>
          </div>
        `
          )
          .join("");
        showToast("Appareils actualis√©s avec succ√®s", "success");
        addActivityLog("Actualisation des appareils");
      })
      .catch((error) => {
        showToast("Erreur lors de l'actualisation des appareils", "error");
        console.error("Device refresh error:", error);
      });
  }

  function clearActivityLog() {
    confirmModal("Voulez-vous vider les logs d'activit√© ?", () => {
      const activityDiv = document.getElementById("recent-activity");
      const startupEntry = activityDiv.children[0];
      activityDiv.innerHTML = "";
      activityDiv.appendChild(startupEntry);
      showToast("Logs d'activit√© vid√©s", "success");
      activityCount = 0;
      document.getElementById("commands-today").textContent = "0";
      document.getElementById("last-command").textContent = "Aucune";
    });
  }

  function exportLogs() {
    showToast("Exportation des logs...", "info");
    fetch("/api/logs/export/", {
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.blob())
      .then((blob) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "logs.json";
        a.click();
        window.URL.revokeObjectURL(url);
        showToast("Logs export√©s avec succ√®s", "success");
        addActivityLog("Export des logs syst√®me");
      })
      .catch((error) => {
        showToast("Erreur lors de l'exportation des logs", "error");
        console.error("Log export error:", error);
      });
  }

  function manageVoiceCommands() {
    showFormModal({
      title: "G√©rer les commandes vocales",
      fields: [
        {
          name: "command",
          label: "Nouvelle commande",
          type: "text",
          placeholder: "Entrez la commande",
        },
        {
          name: "action",
          label: "Action",
          type: "select",
          options: ["Ouvrir porte", "Allumer lumi√®re", "Activer s√©curit√©"],
        },
      ],
      submitText: "Ajouter",
      onSubmit: async (data) => {
        await fetch("/api/voice-commands/add/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(data),
        });
        showToast("Commande vocale ajout√©e", "success");
        addActivityLog("Ajout commande vocale");
      },
    });
  }

  function viewSystemLogs() {
    showToast("Chargement des logs syst√®me...", "info");
    addActivityLog("Consultation logs syst√®me");
    // Implement actual log viewing, e.g., redirect to a logs page
    window.location.href = "/logs/";
  }

  function checkSystemStatus() {
    fetch("/pending/")
      .then((response) => response.json())
      .then((data) => {
        const mqttStatus = document.getElementById("mqtt-status");
        if (data.message !== "no_command") {
          mqttStatus.textContent = "Actif";
          mqttStatus.className = "status-badge status-online";
        }
      })
      .catch(() => {
        const mqttStatus = document.getElementById("mqtt-status");
        mqttStatus.textContent = "D√©connect√©";
        mqttStatus.className = "status-badge status-offline";
      });
  }

  function initDashboard() {
    updateTime();
    checkSpeechRecognition();
    document.getElementById("startup-time").textContent =
      new Date().toLocaleTimeString("fr-FR");
    connectMqttLogWebSocket();
    setInterval(updateTime, 60000);
    setInterval(checkSystemStatus, 30000);
    checkSystemStatus();
  }

  document.addEventListener("DOMContentLoaded", initDashboard);
</script>
{% endblock %}
